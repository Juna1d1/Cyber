<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Object Detection (TensorFlow.js + COCO-SSD) — No Mirror</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto; margin: 16px; background:#f6f8fa; color:#111;}
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    h1 { font-size:18px; margin:0; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    select, button, input[type="number"] {
      padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:white;
    }
    #videoContainer { position:relative; display:inline-block; border-radius:8px; overflow:hidden; background:#000; }
    canvas { display:block; position:absolute; left:0; top:0; }
    #log { margin-top:8px; font-size:13px; color:#444; white-space:pre-wrap; background:#fff;
      padding:8px; border-radius:6px; border:1px solid #e3e6ea; }
    .small { font-size:13px; color:#555; }
    footer { margin-top:12px; font-size:13px; color:#666; }
  </style>

  <!-- TensorFlow.js + COCO-SSD -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
</head>
<body>
  <header>
    <h1>Object Detection (TensorFlow.js · COCO-SSD)</h1>
    <div class="small">Tanpa mirror — kamera & tulisan normal</div>
  </header>

  <div class="controls">
    <label>Kamera:
      <select id="videoSelect"></select>
    </label>

    <label>Resolusi:
      <select id="resolution">
        <option value="640x480">640×480</option>
        <option value="480x360">480×360</option>
        <option value="320x240">320×240</option>
      </select>
    </label>

    <label>Confidence ≥
      <input id="minScore" type="number" value="0.5" step="0.05" min="0" max="1"/>
    </label>

    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
    <button id="snapshotBtn" disabled>Download Snapshot</button>
  </div>

  <div id="videoContainer">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="log">Status: Memuat model…</div>

  <footer>
    Simpan file ini sebagai <code>index.html</code> lalu upload ke GitHub Pages.
  </footer>

<script>
(async () => {
  const video = document.getElementById('video');
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');
  const videoSelect = document.getElementById('videoSelect');
  const resolution = document.getElementById('resolution');
  const minScoreEl = document.getElementById('minScore');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const snapshotBtn = document.getElementById('snapshotBtn');
  const log = document.getElementById('log');

  let stream = null;
  let model = null;
  let rafId = null;
  let detecting = false;

  const info = (...t) => log.textContent = 'Status: ' + t.join(' ');

  // Load model
  try {
    info('Memuat model COCO-SSD...');
    model = await cocoSsd.load();
    info('Model siap — pilih kamera lalu klik Start');
  } catch (e) {
    info('Gagal memuat model: ' + e);
    return;
  }

  async function updateDeviceList() {
    try {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === 'videoinput');
      videoSelect.innerHTML = '';
      cams.forEach((c, i) => {
        const opt = document.createElement('option');
        opt.value = c.deviceId;
        opt.textContent = c.label || `Camera ${i+1}`;
        videoSelect.appendChild(opt);
      });
    } catch (e) {
      console.error(e);
    }
  }

  const parseResolution = val => {
    const [w,h] = val.split('x').map(Number);
    return { width:w, height:h };
  };

  async function start() {
    const deviceId = videoSelect.value;
    const res = parseResolution(resolution.value);

    if (stream) stopStream();

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: deviceId ? { exact: deviceId } : undefined, ...res },
        audio: false
      });
      video.srcObject = stream;
      await video.play();

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      detecting = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      snapshotBtn.disabled = false;

      info('Kamera aktif — mendeteksi objek...');

      detectFrame();
    } catch (e) {
      info('Gagal membuka kamera: ' + e);
    }
  }

  function stopStream() {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = null;
    detecting = false;
    cancelAnimationFrame(rafId);

    ctx.clearRect(0,0,canvas.width,canvas.height);

    startBtn.disabled = false;
    stopBtn.disabled = true;
    snapshotBtn.disabled = true;

    info('Kamera dihentikan.');
  }

  stopBtn.onclick = stopStream;
  startBtn.onclick = start;

  snapshotBtn.onclick = () => {
    const out = document.createElement('canvas');
    out.width = canvas.width;
    out.height = canvas.height;
    const octx = out.getContext('2d');

    // Draw normal (no mirror)
    octx.drawImage(video, 0, 0, out.width, out.height);
    octx.drawImage(canvas, 0, 0);

    out.toBlob(blob => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'snapshot.png';
      a.click();
    });
  };

  async function detectFrame() {
    if (!detecting) return;

    if (video.readyState >= 2) {
      const preds = await model.detect(video);
      drawPredictions(preds);
    }
    rafId = requestAnimationFrame(detectFrame);
  }

  function drawPredictions(preds) {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const minScore = parseFloat(minScoreEl.value);

    preds.forEach(p => {
      if (p.score < minScore) return;

      const [x,y,w,h] = p.bbox;

      ctx.lineWidth = 2;
      ctx.strokeStyle = "#00FF00";
      ctx.fillStyle = "rgba(0,255,0,0.15)";
      ctx.strokeRect(x,y,w,h);
      ctx.fillRect(x,y,w,h);

      const label = `${p.class} ${(p.score*100).toFixed(1)}%`;

      ctx.font = "16px sans-serif";
      const tw = ctx.measureText(label).width;

      ctx.fillStyle = "rgba(0,0,0,0.7)";
      ctx.fillRect(x, y-24, tw+8, 20);

      ctx.fillStyle = "#fff";
      ctx.fillText(label, x+4, y-10);
    });
  }

  navigator.mediaDevices.addEventListener('devicechange', updateDeviceList);
  await updateDeviceList();

})();
</script>
</body>
</html>
